<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>HTP Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/static/icoRGB.ico">
  <link rel="stylesheet" href="/static/interface.css">
</head>
<body>
  <div class="htp-container">
    <header class="htp-header">
      <div class="htp-logo">
        <img src="/static/icoRGB.ico" alt="HTP" class="htp-logo-img">
        <span class="htp-title">HTP - High Tech Player</span>
      </div>
      <div class="htp-status">
        <span id="vision-status-dot" class="status-dot"></span>
        <span id="vision-status-text">Desconocido</span>
      </div>
    </header>

    <main class="htp-main">
      <section class="htp-card">
        <h2>Decisión</h2>
        <div class="htp-row">
          <span class="htp-label">Equity:</span>
          <span id="equity" class="htp-value">--%</span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Acción:</span>
          <span id="action" class="htp-value">ESPERANDO...</span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Pot Odds:</span>
          <span id="pot_odds" class="htp-value"></span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Tags:</span>
          <span id="tags" class="htp-value"></span>
        </div>
      </section>

      <section class="htp-card">
        <h2>Estado de la Mesa</h2>
        <div class="htp-row">
          <span class="htp-label">Street:</span>
          <span id="street" class="htp-value">PREFLOP</span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Mis Cartas:</span>
          <span id="my_cards" class="htp-value"></span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Board:</span>
          <span id="board" class="htp-value"></span>
        </div>
        <div class="htp-row">
          <span class="htp-label">Blinds:</span>
          <span id="blinds" class="htp-value"></span>
        </div>
      </section>

      <section class="htp-card">
        <h2>Errores recientes</h2>
        <pre id="errors" class="htp-errors"></pre>
      </section>
    </main>
  </div>

  <script>
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://')
                + location.host + '/ws';

    function cardListToString(cards) {
      if (!cards || !cards.length) return '';
      return cards.join(' ');
    }

    function updateVision(ok) {
      const dot = document.getElementById('vision-status-dot');
      const text = document.getElementById('vision-status-text');
      if (ok) {
        dot.classList.remove('status-bad');
        dot.classList.add('status-ok');
        text.textContent = 'Captura OK';
      } else {
        dot.classList.remove('status-ok');
        dot.classList.add('status-bad');
        text.textContent = 'Problema de visión / pantalla negra';
      }
    }

    function connect() {
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WS conectado');
        ws.send(JSON.stringify({ action: 'ping' }));
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const decision = data.decision || {};
          const game = data.game_state || {};
          const ocr = data.ocr_data || {};

          document.getElementById('equity').textContent = decision.equity || '--%';
          document.getElementById('action').textContent = decision.action || 'ESPERANDO...';
          document.getElementById('pot_odds').textContent = decision.pot_odds || '';
          document.getElementById('tags').textContent = (decision.tags || []).join(', ');

          document.getElementById('street').textContent = game.street || 'PREFLOP';
          document.getElementById('my_cards').textContent = cardListToString(game.my_cards || []);
          document.getElementById('board').textContent = cardListToString(game.board || []);
          const blinds = game.blinds || {};
          document.getElementById('blinds').textContent =
            `SB: ${blinds.sb || 0}, BB: ${blinds.bb || 0}`;

          updateVision(!!data.vision_ok);

          const errs = data.errors || [];
          document.getElementById('errors').textContent = errs.join('\\n');
        } catch (e) {
          console.error('Error parseando mensaje WS', e);
        }
      };

      ws.onclose = () => {
        console.log('WS cerrado, reintento en 2s...');
        setTimeout(connect, 2000);
      };

      ws.onerror = (err) => {
        console.error('WS error', err);
        ws.close();
      };
    }

    connect();
  </script>
</body>
</html>
